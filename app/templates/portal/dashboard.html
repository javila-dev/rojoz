{% extends "portal/base_portal.html" %}
{% load humanize %}

{% block title %}Mis contratos{% endblock %}

{% block nav_dashboard_class %}text-rojoz-700 bg-rojoz-50 font-semibold{% endblock %}
{% block nav_mobile_dashboard %}text-rojoz-700 bg-rojoz-50 font-semibold{% endblock %}

{% block content %}
<div class="space-y-6">

    <!-- Header -->
    <div>
        <h1 class="text-2xl font-bold text-gray-900" style="font-family: 'Playfair Display', serif;">
            Hola, {{ client_name }}
        </h1>
        <p class="text-gray-500 mt-1 text-sm">
            Tienes {{ sales_count }} contrato{{ sales_count|pluralize:"s" }} asociado{{ sales_count|pluralize:"s" }} a tu cuenta.
        </p>
    </div>

    {% if rows %}
    <div class="grid grid-cols-1 gap-5">
        {% for row in rows %}
        <div class="card bg-white rounded-xl overflow-hidden">
            <div class="p-5 sm:p-6">
                <!-- Top: proyecto + estado -->
                <div class="flex items-start justify-between gap-3 mb-4">
                    <div class="min-w-0">
                        <div class="flex items-center gap-2 flex-wrap">
                            <h2 class="text-lg font-bold text-gray-900">{{ row.sale.project.name }}</h2>
                            {% if row.sale.status == 'APP' %}
                            <span class="badge badge-sm bg-emerald-100 text-emerald-700 border-0">Aprobado</span>
                            {% elif row.sale.status == 'PEND' %}
                            <span class="badge badge-sm bg-amber-100 text-amber-700 border-0">Pendiente</span>
                            {% else %}
                            <span class="badge badge-sm bg-gray-100 text-gray-600 border-0">{{ row.sale.get_status_display }}</span>
                            {% endif %}
                        </div>
                        <p class="text-sm text-gray-500 mt-0.5">
                            {{ row.sale.house_type.name }}
                            {% if row.sale.contract_number %} &middot; Contrato #{{ row.sale.contract_number }}{% endif %}
                            {% if row.sale.lot_metadata.lote %} &middot; Lote {{ row.sale.lot_metadata.lote }}{% endif %}
                            {% if row.sale.lot_metadata.manzana %}, Mz {{ row.sale.lot_metadata.manzana }}{% endif %}
                        </p>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="text-xs text-gray-400 uppercase tracking-wide">Valor</p>
                        <p class="text-lg font-bold text-gray-900">${{ row.sale.final_price|floatformat:0|intcomma }}</p>
                    </div>
                </div>

                <!-- Barra de progreso -->
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-1.5">
                        <span class="text-xs font-semibold text-gray-500">Progreso de pago</span>
                        <span class="text-xs font-bold text-rojoz-600">{{ row.pct_paid }}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" style="width: {{ row.pct_paid }}%"></div>
                    </div>
                </div>

                <!-- Stats row -->
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div class="bg-emerald-50 rounded-lg p-3 text-center">
                        <p class="text-xs text-emerald-600 font-medium">Pagado</p>
                        <p class="text-sm font-bold text-emerald-800">${{ row.total_paid|floatformat:0|intcomma }}</p>
                    </div>
                    <div class="bg-amber-50 rounded-lg p-3 text-center">
                        <p class="text-xs text-amber-600 font-medium">Pendiente</p>
                        <p class="text-sm font-bold text-amber-800">${{ row.pending|floatformat:0|intcomma }}</p>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-3 text-center">
                        <p class="text-xs text-blue-600 font-medium">Proxima cuota</p>
                        {% if row.next_installment %}
                        <p class="text-sm font-bold text-blue-800">${{ row.next_installment.valor_total|floatformat:0|intcomma }}</p>
                        <p class="text-xs text-blue-500">{{ row.next_installment.fecha|date:"d M Y" }}</p>
                        {% else %}
                        <p class="text-sm font-bold text-blue-800">--</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex items-center gap-2">
                    <a href="{% url 'portal:contract_detail' row.sale.pk %}" class="btn btn-sm btn-primary gap-1">
                        <i class="ri-file-text-line"></i> Ver detalle
                    </a>
                    <a href="{% url 'portal:payments' row.sale.pk %}" class="btn btn-sm btn-neutral-elegant gap-1">
                        <i class="ri-money-dollar-circle-line"></i> Ver pagos
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <!-- Empty state -->
    <div class="card bg-white rounded-xl p-12 text-center">
        <div class="w-20 h-20 mx-auto rounded-2xl bg-rojoz-50 flex items-center justify-center mb-4">
            <i class="ri-file-search-line text-3xl text-rojoz-400"></i>
        </div>
        <h2 class="text-lg font-bold text-gray-800 mb-2">Aun no tienes contratos</h2>
        <p class="text-sm text-gray-500 max-w-md mx-auto">
            No encontramos contratos asociados a tu correo electronico. Si crees que es un error, contacta a tu asesor comercial.
        </p>
    </div>
    {% endif %}

</div>
{% endblock %}
