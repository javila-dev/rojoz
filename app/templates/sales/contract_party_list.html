{% extends "base.html" %}

{% block title %}Terceros{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
    <div class="rounded-2xl border border-gray-200 bg-white/80 backdrop-blur-xl shadow-sm p-6 lg:p-8">
        <div class="flex flex-wrap items-end justify-between gap-4">
            <div>
                <h1 class="text-3xl lg:text-4xl font-bold text-gray-900">Terceros</h1>
                <p class="text-sm text-gray-600 mt-1">Base unificada de titulares vinculados a contratos.</p>
            </div>
            <div class="text-sm text-gray-600">Total: <span class="font-semibold">{{ total_parties }}</span></div>
        </div>

        <form method="get" class="mt-6 grid grid-cols-1 md:grid-cols-[1fr_auto] gap-3">
            <input
                type="text"
                name="q"
                value="{{ query }}"
                placeholder="Buscar por nombre, documento, email, celular o ciudad"
                class="input input-bordered w-full"
            >
            <button type="submit" class="btn btn-neutral-elegant">Buscar</button>
        </form>
    </div>

    <div class="card bg-white border border-gray-200 shadow-sm">
        <div class="card-body p-0">
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full text-sm">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Documento</th>
                            <th>Email</th>
                            <th>Celular</th>
                            <th>Ciudad</th>
                            <th class="text-right">Contratos</th>
                            <th class="text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for party in page_obj %}
                        <tr>
                            <td class="font-semibold">{{ party.full_name }}</td>
                            <td>{{ party.document_type_label }} {{ party.document_number }}</td>
                            <td>{{ party.email|default:"—" }}</td>
                            <td>{{ party.mobile|default:party.phone_alt|default:"—" }}</td>
                            <td>{{ party.city_name|default:party.city|default:"—" }}</td>
                            <td class="text-right">{{ party.sales_count }}</td>
                            <td class="text-right">
                                <label for="party_detail_modal_{{ party.id }}" class="btn btn-xs btn-neutral-elegant">Detalle</label>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-gray-500 py-8">No hay terceros registrados.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% if page_obj.paginator.num_pages > 1 %}
    <div class="flex items-center justify-end gap-2">
        {% if page_obj.has_previous %}
        <a class="btn btn-sm btn-neutral-elegant" href="?q={{ query|urlencode }}&page={{ page_obj.previous_page_number }}">Anterior</a>
        {% endif %}
        <span class="text-sm text-gray-600">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
        <a class="btn btn-sm btn-neutral-elegant" href="?q={{ query|urlencode }}&page={{ page_obj.next_page_number }}">Siguiente</a>
        {% endif %}
    </div>
    {% endif %}

    {% for party in page_obj %}
    <input type="checkbox" id="party_detail_modal_{{ party.id }}" class="modal-toggle">
    <div class="modal" role="dialog">
        <div class="modal-box max-w-4xl">
            <div class="flex items-start justify-between gap-3">
                <div>
                    <h3 class="text-xl font-semibold text-gray-900">{{ party.full_name }}</h3>
                    <p class="text-sm text-gray-600">{{ party.document_type_label }} {{ party.document_number }}</p>
                </div>
                <label for="party_detail_modal_{{ party.id }}" class="btn btn-sm btn-neutral-elegant">Cerrar</label>
            </div>

            <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <div class="rounded-lg border border-gray-200 p-3"><span class="text-gray-500">Nombres</span><div class="font-semibold">{{ party.first_names|default:"—" }}</div></div>
                <div class="rounded-lg border border-gray-200 p-3"><span class="text-gray-500">Apellidos</span><div class="font-semibold">{{ party.last_names|default:"—" }}</div></div>
                <div class="rounded-lg border border-gray-200 p-3"><span class="text-gray-500">Email</span><div class="font-semibold">{{ party.email|default:"—" }}</div></div>
                <div class="rounded-lg border border-gray-200 p-3"><span class="text-gray-500">Celular</span><div class="font-semibold">{{ party.mobile|default:"—" }}</div></div>
                <div class="rounded-lg border border-gray-200 p-3"><span class="text-gray-500">Celular alterno</span><div class="font-semibold">{{ party.mobile_alt|default:"—" }}</div></div>
                <div class="rounded-lg border border-gray-200 p-3"><span class="text-gray-500">Teléfono</span><div class="font-semibold">{{ party.phone|default:party.phone_alt|default:"—" }}</div></div>
                <div class="rounded-lg border border-gray-200 p-3"><span class="text-gray-500">Dirección</span><div class="font-semibold">{{ party.address|default:"—" }}</div></div>
                <div class="rounded-lg border border-gray-200 p-3"><span class="text-gray-500">Ciudad</span><div class="font-semibold">{{ party.city_name|default:party.city|default:"—" }}</div></div>
                <div class="rounded-lg border border-gray-200 p-3"><span class="text-gray-500">Departamento</span><div class="font-semibold">{{ party.department|default:"—" }}</div></div>
                <div class="rounded-lg border border-gray-200 p-3"><span class="text-gray-500">País</span><div class="font-semibold">{{ party.country|default:"—" }}</div></div>
                <div class="rounded-lg border border-gray-200 p-3"><span class="text-gray-500">Fecha de nacimiento</span><div class="font-semibold">{{ party.birth_date|date:"Y-m-d"|default:"—" }}</div></div>
                <div class="rounded-lg border border-gray-200 p-3"><span class="text-gray-500">Lugar de nacimiento</span><div class="font-semibold">{{ party.birth_place|default:"—" }}</div></div>
                <div class="rounded-lg border border-gray-200 p-3"><span class="text-gray-500">Nacionalidad</span><div class="font-semibold">{{ party.nationality|default:"—" }}</div></div>
                <div class="rounded-lg border border-gray-200 p-3"><span class="text-gray-500">Ocupación</span><div class="font-semibold">{{ party.occupation|default:"—" }}</div></div>
                <div class="rounded-lg border border-gray-200 p-3"><span class="text-gray-500">Estado civil</span><div class="font-semibold">{{ party.marital_status|default:"—" }}</div></div>
                <div class="rounded-lg border border-gray-200 p-3"><span class="text-gray-500">Sagrilaft</span><div class="font-semibold">{{ party.sagrilaft|default:"—" }}</div></div>
                <div class="rounded-lg border border-gray-200 p-3"><span class="text-gray-500">ID externo</span><div class="font-semibold">{{ party.external_id|default:"—" }}</div></div>
                <div class="rounded-lg border border-gray-200 p-3"><span class="text-gray-500">Posición</span><div class="font-semibold">{{ party.position|default:"—" }}</div></div>
            </div>

            <div class="mt-5">
                <h4 class="font-semibold text-gray-900 mb-2">Contratos vinculados</h4>
                <div class="overflow-x-auto border border-gray-200 rounded-lg">
                    <table class="table table-zebra w-full text-sm">
                        <thead>
                            <tr>
                                <th># Contrato</th>
                                <th>Proyecto</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th class="text-right"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sale in party.sales.all %}
                            <tr>
                                <td>{{ sale.contract_number|default:"—" }}</td>
                                <td>{{ sale.project.name }}</td>
                                <td>{{ sale.get_status_display }}</td>
                                <td>{{ sale.date_created|date:"Y-m-d" }}</td>
                                <td class="text-right"><a href="{% url 'sales:contract_detail' sale.id %}" class="btn btn-xs btn-neutral-elegant">Ver</a></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-gray-500 py-5">Sin contratos vinculados.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            {% if party.payload %}
            <div class="mt-5">
                <h4 class="font-semibold text-gray-900 mb-2">Payload origen</h4>
                <pre class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-xs overflow-x-auto">{{ party.payload }}</pre>
            </div>
            {% endif %}
        </div>
        <label class="modal-backdrop" for="party_detail_modal_{{ party.id }}">Cerrar</label>
    </div>
    {% endfor %}
</div>
{% endblock %}
