{% extends "base.html" %}

{% block title %}Roles y permisos{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900" style="font-family:'Playfair Display',serif;">Roles y permisos</h1>
            <p class="text-sm text-gray-500">Activa accesos por rol para cada funcion del sistema.</p>
        </div>
    </div>

    <form method="post" class="space-y-6">
        {% csrf_token %}

        {% for group in grouped %}
        <div class="collapse collapse-arrow bg-white border border-gray-200 shadow-sm">
            <input type="checkbox" {% if forloop.first %}checked{% endif %}>
            <div class="collapse-title px-6 py-4 bg-gradient-to-r from-gray-50 to-white border-b border-gray-100">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-rojoz-600 to-rojoz-500 flex items-center justify-center text-white text-sm">
                        {% if group.app == "inventory" %}
                            <i class="ri-building-2-line"></i>
                        {% elif group.app == "sales" %}
                            <i class="ri-shopping-cart-line"></i>
                        {% elif group.app == "finance" %}
                            <i class="ri-money-dollar-circle-line"></i>
                        {% elif group.app == "documents" %}
                            <i class="ri-file-text-line"></i>
                        {% elif group.app == "users" %}
                            <i class="ri-user-settings-line"></i>
                        {% else %}
                            <i class="ri-apps-line"></i>
                        {% endif %}
                    </div>
                    <div class="min-w-0">
                        <h2 class="text-lg font-bold text-gray-800">{{ group.app_label }}</h2>
                        <p class="text-xs text-gray-400">{{ group.permissions|length }} permisos</p>
                    </div>
                </div>
            </div>

            <div class="collapse-content p-0">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-100 bg-gray-50/50">
                                <th class="text-left px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider w-[35%]">Funcion</th>
                                <th class="text-center px-3 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider w-[8%]">Tipo</th>
                                {% for role in role_defs %}
                                <th class="text-center px-3 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">{{ role.label }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-50">
                            {% for perm in group.permissions %}
                            <tr class="hover:bg-rojoz-50/30 transition-colors">
                                <td class="px-6 py-3">
                                    <div class="font-medium text-gray-800 text-sm">{{ perm.label }}</div>
                                    <div class="text-xs text-gray-400 mt-0.5">{{ perm.key }}</div>
                                </td>
                                <td class="text-center px-3 py-3">
                                    {% if perm.action == "ver" %}
                                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-100">
                                            <i class="ri-eye-line text-[10px]"></i> Ver
                                        </span>
                                    {% elif perm.action == "editar" %}
                                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-50 text-amber-700 border border-amber-100">
                                            <i class="ri-pencil-line text-[10px]"></i> Editar
                                        </span>
                                    {% elif perm.action == "eliminar" %}
                                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-red-50 text-red-700 border border-red-100">
                                            <i class="ri-delete-bin-line text-[10px]"></i> Eliminar
                                        </span>
                                    {% endif %}
                                </td>
                                {% for role in role_defs %}
                                    {% with field_name="perm__"|add:role.code|add:"__"|add:perm.field_key %}
                                        {% with map_key=role.code|add:"::"|add:perm.key %}
                                        <td class="text-center px-3 py-3">
                                            <input type="checkbox"
                                                   class="checkbox checkbox-sm checkbox-primary"
                                                   name="{{ field_name }}"
                                                   {% if map_key in existing_keys %}checked{% endif %}>
                                        </td>
                                        {% endwith %}
                                    {% endwith %}
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Sticky save bar -->
        <div class="sticky bottom-4 z-10">
            <div class="bg-white/90 backdrop-blur-sm rounded-xl border border-gray-200 shadow-lg px-6 py-3 flex items-center justify-between">
                <p class="text-sm text-gray-500">
                    <i class="ri-information-line mr-1"></i>
                    Los cambios aplican inmediatamente al guardar.
                </p>
                <button type="submit" class="btn btn-primary gap-2">
                    <i class="ri-save-line"></i>
                    Guardar permisos
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}
